<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>iPad Express Checkout - Phase III</title>

  <!-- ZXing QR Code Library -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    :root{
      --primary:#4f46e5;
      --success:#10b981;
      --bg:#0f172a;
      --panel:#1e293b;
      --danger:#ef4444;
      --gray:#334155;
      --warning:#f59e0b;
      --vh:1vh;
      
      /* PHASE III: Enhanced Semantic Color Coding */
      --actionable-blue:#3b82f6;
      --active-zone:#1e3a8a;
      --audit-grey:#64748b;
      --historical-bg:#334155;
      --transaction-bg:#0c4a6e;
    }

    *{ box-sizing:border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:#fff;
      margin:0;
      display:flex;
      flex-direction:column;
      height:calc(var(--vh) * 100);
      overflow:hidden;
      -webkit-user-select:none;
      -webkit-tap-highlight-color:transparent;
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }

    .header{
      padding:10px;
      background:var(--panel);
      border-bottom:1px solid var(--gray);
      flex-shrink:0;
    }

    .mode-toggle{
      display:flex;
      background:#0f172a;
      border-radius:10px;
      padding:4px;
      margin:0 auto;
      width:min(520px, 100%);
    }

    .mode-btn{
      flex:1;
      padding:12px;
      border:none;
      border-radius:8px;
      color:#94a3b8;
      background:none;
      font-size:1.05rem;
      font-weight:800;
      cursor:pointer;
      transition:0.2s;
    }

    .mode-btn.active{
      background:var(--primary);
      color:#fff;
    }

    #reader-container{
      width:min(560px, 100%);
      margin:10px auto 0;
      padding:0 12px;
      position:relative;
      flex-shrink:0;
    }

    #reader{
      width:100% !important;
      height:clamp(220px, 38vh, 360px) !important;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      border:2px solid var(--gray);
      object-fit:cover;
      display:block;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    @supports (-webkit-touch-callout: none) {
      #reader {
        height: calc(clamp(220px, 38vh, 360px) - env(safe-area-inset-bottom)) !important;
      }
    }

    .scan-overlay{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:min(260px, 72vw);
      height:min(260px, 72vw);
      max-width:260px;
      max-height:260px;
      border:3px solid var(--success);
      border-radius:14px;
      pointer-events:none;
      opacity:0.55;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .scan-overlay.scanning{
      animation:pulse 2s infinite;
    }

    .scan-overlay.cooldown{
      border-color:var(--warning);
      opacity:0.3;
      animation:none;
    }

    .scan-overlay.feedback-success {
      border-color: #10b981;
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.6);
      animation: successPulse 0.5s ease-out;
    }

    .scan-overlay.feedback-error {
      border-color: #ef4444;
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
      animation: errorShake 0.5s ease-out;
    }

    .scan-overlay.visual-shake {
      animation: visualShake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes visualShake {
      10%, 90% { transform: translate(-50%, -50%) translateX(-5px); }
      20%, 80% { transform: translate(-50%, -50%) translateX(5px); }
      30%, 50%, 70% { transform: translate(-50%, -50%) translateX(-3px); }
      40%, 60% { transform: translate(-50%, -50%) translateX(3px); }
    }

    @keyframes pulse{
      0%,100%{ opacity:0.55; }
      50%{ opacity:0.25; }
    }

    @keyframes successPulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translate(-50%, -50%) translateX(0); }
      25% { transform: translate(-50%, -50%) translateX(-10px); }
      75% { transform: translate(-50%, -50%) translateX(10px); }
    }

    .scan-corner{
      position:absolute;
      width:30px;
      height:30px;
      border:3px solid var(--success);
      transition:border-color 0.2s;
    }
    
    .scan-overlay.cooldown .scan-corner,
    .scan-overlay.feedback-error .scan-corner{
      border-color:var(--warning);
    }

    .scan-overlay.feedback-success .scan-corner{
      border-color:#10b981;
    }
    
    .scan-corner.tl{ top:0; left:0; border-right:none; border-bottom:none; }
    .scan-corner.tr{ top:0; right:0; border-left:none; border-bottom:none; }
    .scan-corner.bl{ bottom:0; left:0; border-right:none; border-top:none; }
    .scan-corner.br{ bottom:0; right:0; border-left:none; border-top:none; }

    /* ===== PHASE III: VERIFICATION MODAL (Two-Stage Protocol) ===== */
    .verification-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.97);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
      padding: 20px;
    }

    .verification-modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 3px solid var(--actionable-blue);
      border-radius: 24px;
      padding: 32px;
      max-width: 95%;
      width: 520px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .verification-modal-content h2 {
      margin: 0 0 8px;
      font-size: 26px;
      color: #fff;
      text-align: center;
    }

    .verification-modal-content .subtitle {
      text-align: center;
      color: #94a3b8;
      font-size: 15px;
      margin-bottom: 24px;
    }

    .verification-summary {
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid var(--actionable-blue);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .verification-summary-item {
      text-align: center;
    }

    .verification-summary-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .verification-summary-value {
      font-size: 28px;
      font-weight: 900;
      color: var(--actionable-blue);
      font-family: monospace;
    }

    .verification-items-container {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 24px;
      max-height: 40vh;
      overflow-y: auto;
    }

    .verification-item {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .verification-item:last-child {
      margin-bottom: 0;
    }

    .verification-item-icon {
      font-size: 24px;
    }

    .verification-item-text {
      flex: 1;
      font-family: monospace;
      font-size: 16px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .verification-modal-buttons {
      display: flex;
      gap: 12px;
    }

    .verification-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .verification-btn-cancel {
      background: #334155;
      color: #cbd5e1;
    }

    .verification-btn-cancel:hover {
      background: #475569;
    }

    .verification-btn-confirm {
      background: var(--actionable-blue);
      color: white;
    }

    .verification-btn-confirm:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    }

    /* ===== PHASE III: RESULTS MODAL (Granular Error Reporting) ===== */
    .results-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.97);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.2s ease-out;
      padding: 20px;
    }

    .results-modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 3px solid var(--success);
      border-radius: 24px;
      padding: 32px;
      max-width: 95%;
      width: 540px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .results-modal-content.has-errors {
      border-color: var(--danger);
    }

    .results-modal-content h2 {
      margin: 0 0 8px;
      font-size: 26px;
      color: #fff;
      text-align: center;
    }

    .results-summary {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid var(--success);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
    }

    .results-summary.has-failures {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
    }

    .results-summary-text {
      font-size: 18px;
      color: #e2e8f0;
      margin-bottom: 8px;
    }

    .results-summary-stats {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 12px;
    }

    .results-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .results-stat-icon {
      font-size: 20px;
    }

    .results-stat-label {
      font-size: 14px;
      color: #94a3b8;
    }

    .results-stat-value {
      font-size: 24px;
      font-weight: 900;
      font-family: monospace;
    }

    .results-stat.success .results-stat-value {
      color: var(--success);
    }

    .results-stat.failure .results-stat-value {
      color: var(--danger);
    }

    .results-items-container {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 24px;
      max-height: 45vh;
      overflow-y: auto;
    }

    .result-item {
      background: #1e293b;
      border-left: 4px solid var(--success);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .result-item:last-child {
      margin-bottom: 0;
    }

    .result-item.failure {
      border-left-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    .result-item-icon {
      font-size: 24px;
      margin-top: 2px;
    }

    .result-item-content {
      flex: 1;
    }

    .result-item-id {
      font-family: monospace;
      font-size: 16px;
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 4px;
    }

    .result-item-reason {
      font-size: 13px;
      color: #94a3b8;
      line-height: 1.4;
    }

    .result-item.failure .result-item-reason {
      color: #fca5a5;
    }

    .results-modal-close {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      background: var(--success);
      color: white;
      transition: all 0.2s;
    }

    .results-modal-close:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }

    /* ===== USER CONFIRMATION MODAL (Initial User Scan) ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 3px solid #10b981;
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      max-width: 90%;
      width: 420px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .checkmark-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      margin: 0 auto 20px;
      animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .modal-content h2 {
      margin: 0 0 16px;
      font-size: 28px;
      color: #fff;
    }

    .user-info {
      font-size: 18px;
      color: #cbd5e1;
      margin-bottom: 24px;
    }

    .user-info strong {
      display: block;
      font-size: 24px;
      color: #10b981;
      margin-bottom: 8px;
      font-family: monospace;
    }

    .next-step {
      background: rgba(79, 70, 229, 0.2);
      border: 2px dashed #4f46e5;
      border-radius: 16px;
      padding: 20px;
      margin: 24px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .arrow-icon {
      font-size: 32px;
      color: #4f46e5;
      animation: bounce 1s infinite;
    }

    .next-step p {
      margin: 0;
      font-size: 18px;
      color: #e2e8f0;
      font-weight: 600;
    }

    .modal-close {
      background: #10b981;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .status-banner{
      padding:14px 18px;
      text-align:center;
      font-weight:900;
      font-size:1.05rem;
      border-bottom:2px solid transparent;
      letter-spacing:0.3px;
      transition:all 0.3s;
    }

    .status-waiting{ background:#1e3a8a; color:#bfdbfe; border-bottom-color:#3b82f6; }
    .status-success{ background:#065f46; color:#a7f3d0; border-bottom-color:#10b981; }
    .status-error{ background:#7f1d1d; color:#fecaca; border-bottom-color:#ef4444; }
    .status-warning{ background:#78350f; color:#fde68a; border-bottom-color:#f59e0b; }

    /* ===== PHASE III: UI PARTITIONING (Transaction vs History) ===== */
    .main-content {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
    }

    .transaction-zone {
      background: linear-gradient(135deg, var(--transaction-bg) 0%, #0e7490 100%);
      border: 2px solid var(--actionable-blue);
      border-radius: 16px;
      padding: 16px;
      min-height: 140px;
    }

    .zone-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 12px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .zone-label-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--actionable-blue);
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .history-zone {
      background: var(--historical-bg);
      border: 1px solid #475569;
      border-radius: 16px;
      padding: 16px;
      opacity: 0.85;
      flex: 1;
      min-height: 160px;
      display: flex;
      flex-direction: column;
    }

    #userPanel{
      display:none;
      align-items:center;
      justify-content:space-between;
      background:rgba(16,185,129,0.1);
      border:2px solid var(--success);
      border-radius:12px;
      padding:12px 16px;
      margin-bottom: 12px;
    }

    #currentUserId{
      font-family:monospace;
      font-size:1.1rem;
      font-weight:900;
      color:var(--success);
    }

    #sessionCount{
      font-size:1.3rem;
      font-weight:900;
      color:var(--actionable-blue);
      font-family:monospace;
      background: rgba(59, 130, 246, 0.2);
      padding: 6px 14px;
      border-radius: 8px;
    }

    #historyList{
      display:none;
      flex-direction:column;
      gap:8px;
    }

    .history-row{
      background:#1e293b;
      border:1px solid #334155;
      border-radius:10px;
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:0.2s;
    }

    .history-row:hover{
      background:#334155;
      border-color:#475569;
    }

    .history-label{
      font-family:monospace;
      font-size:0.95rem;
      font-weight:700;
      color:#e2e8f0;
    }

    .delete-btn{
      background:var(--danger);
      color:#fff;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      font-size:0.75rem;
      font-weight:800;
      cursor:pointer;
      transition:0.2s;
    }

    .delete-btn:hover{
      background:#dc2626;
      transform:scale(1.05);
    }

    .action-bar{
      padding:12px;
      background:var(--panel);
      border-top:1px solid var(--gray);
      display:flex;
      gap:10px;
      flex-shrink:0;
    }

    .action-btn{
      flex:1;
      padding:14px;
      border:none;
      border-radius:10px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      transition:all 0.2s;
    }

    #finishBtn{
      background:linear-gradient(135deg, var(--actionable-blue), #2563eb);
      color:#fff;
      box-shadow:0 4px 12px rgba(59,130,246,0.3);
    }

    #finishBtn:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(59,130,246,0.4);
    }

    #finishBtn:disabled{
      background:#334155;
      color:#64748b;
      cursor:not-allowed;
      box-shadow:none;
    }

    #clearBtn{
      background:#334155;
      color:#cbd5e1;
    }

    #clearBtn:hover{
      background:#475569;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #64748b;
      font-size: 14px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="mode-toggle">
      <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
      <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
  </div>

  <!-- Status Banner -->
  <div id="statusBanner" class="status-banner status-waiting">STEP 1: SCAN USER ID</div>

  <!-- QR Scanner -->
  <div id="reader-container">
    <div id="reader"></div>
    <div class="scan-overlay scanning" id="scanOverlay">
      <div class="scan-corner tl"></div>
      <div class="scan-corner tr"></div>
      <div class="scan-corner bl"></div>
      <div class="scan-corner br"></div>
    </div>
  </div>

  <!-- PHASE III: Partitioned Content Areas -->
  <div class="main-content">
    <!-- Transaction Zone (Active Session) -->
    <div class="transaction-zone">
      <div class="zone-label">
        <span class="zone-label-icon"></span>
        CURRENT SESSION (PENDING)
      </div>

      <div id="userPanel">
        <div>
          <div style="font-size:0.75rem; color:#94a3b8; margin-bottom:4px;">USER</div>
          <div id="currentUserId">‚Äî</div>
        </div>
        <div>
          <div style="font-size:0.75rem; color:#94a3b8; margin-bottom:4px; text-align:right;">QTY</div>
          <div id="sessionCount">0</div>
        </div>
      </div>

      <div id="historyList"></div>

      <div id="emptyTransactionState" class="empty-state">
        <div class="empty-state-icon">üì±</div>
        <div>No items scanned yet</div>
      </div>
    </div>

    <!-- History Zone (Completed Transactions) -->
    <div class="history-zone">
      <div class="zone-label">
        <span class="zone-label-icon" style="background:#64748b;"></span>
        COMPLETED TRANSACTIONS
      </div>
      <div id="completedHistory" class="empty-state" style="flex:1; display:flex; align-items:center; justify-content:center;">
        <div>
          <div class="empty-state-icon">üìã</div>
          <div>History will appear here after transactions</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <button id="finishBtn" class="action-btn" onclick="showVerificationModal()" disabled>FINISH SESSION</button>
    <button id="clearBtn" class="action-btn" onclick="clearAll()">CLEAR</button>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz38EuFK97iTsGqQf-b3BI108nJbzN6xZtEc2tqyk5K93I1kX9UIKqFVRD3DuCFUn_I/exec";
    
    const COOLDOWN_MS = 800;
    const DUPLICATE_WINDOW = 2000;

    // ===== STATE =====
    let mode = "borrow";
    let userId = null;
    let sessionHistory = [];
    let isProcessing = false;
    let lastScanned = null;
    let lastScanTime = 0;
    let isInCooldown = false;
    let cooldownTimer = null;
    let historyDom = new Map();
    let zxingCodeReader = null;

    // Server cache
    let knownUsersSet = new Set();
    let knownIpadsSet = new Set();
    let unavailableIpads = [];

    // ===== VIEWPORT FIX FOR iOS =====
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);

    // ===== LOGGING =====
    function log(...args) {
      console.log(new Date().toISOString(), ...args);
    }

    // ===== CACHE SYNC =====
    async function syncSystemCache() {
      try {
        const url = SCRIPT_URL + "?action=getSystemData";
        const resp = await fetch(url, { method: "GET" });
        const data = await resp.json();

        if (data.users && Array.isArray(data.users)) {
          knownUsersSet = new Set(data.users.map(u => String(u).trim().toUpperCase()));
          log("User cache loaded:", knownUsersSet.size, "users");
        }

        if (data.ipads && Array.isArray(data.ipads)) {
          knownIpadsSet = new Set(data.ipads.map(i => String(i).trim().toUpperCase()));
          log("iPad cache loaded:", knownIpadsSet.size, "iPads");
        }

        if (mode === "borrow" && data.unavailable && Array.isArray(data.unavailable)) {
          unavailableIpads = data.unavailable.map(i => String(i).trim().toUpperCase());
          log("Unavailable iPads:", unavailableIpads.length);
        } else {
          unavailableIpads = [];
        }
      } catch (err) {
        log("Cache sync failed:", err);
      }
    }

    // ===== ZXING SCANNER INITIALIZATION =====
    async function initZXingScanner() {
      try {
        const codeReader = new ZXing.BrowserQRCodeReader();
        zxingCodeReader = codeReader;

        const devices = await codeReader.listVideoInputDevices();
        const backCamera = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];

        if (!backCamera) {
          updateBanner("NO CAMERA FOUND", "status-error");
          return;
        }

        log("Starting ZXing with device:", backCamera.label);

        await codeReader.decodeFromVideoDevice(
          backCamera.deviceId,
          'reader',
          (result, err) => {
            if (result) {
              onScanSuccess(result.text);
            }
          }
        );

        log("ZXing scanner initialized successfully");
      } catch (err) {
        log("ZXing init error:", err);
        updateBanner("CAMERA ACCESS DENIED", "status-error");
      }
    }

    async function stopZXingScanner() {
      if (zxingCodeReader) {
        zxingCodeReader.reset();
        log("ZXing scanner stopped");
      }
    }

    // ===== BANNER & FEEDBACK =====
    function updateBanner(text, className) {
      const banner = document.getElementById("statusBanner");
      banner.innerText = text;
      banner.className = "status-banner " + className;
    }

    function triggerFeedback(type) {
      const overlay = document.getElementById("scanOverlay");
      overlay.classList.remove("feedback-success", "feedback-error", "scanning", "cooldown", "visual-shake");

      if (type === "success") {
        overlay.classList.add("feedback-success");
        playAudioFeedback("success");
      } else if (type === "error" || type === "warning") {
        overlay.classList.add("feedback-error", "visual-shake");
        playAudioFeedback("error");
      } else if (type === "complete") {
        playAudioFeedback("complete");
      }

      setTimeout(() => {
        overlay.classList.remove("feedback-success", "feedback-error", "visual-shake");
        if (!isInCooldown) overlay.classList.add("scanning");
      }, 500);
    }

    // ===== HAPTIC FEEDBACK (PHASE III) =====
    function triggerHaptic(pattern) {
      if ('vibrate' in navigator) {
        try {
          if (pattern === 'success') {
            navigator.vibrate([50, 30, 50]);
          } else if (pattern === 'error') {
            navigator.vibrate([200, 100, 200, 100, 200]);
          } else if (pattern === 'light') {
            navigator.vibrate(30);
          }
        } catch (e) {
          log("Haptic failed:", e);
        }
      }
    }

    // ===== AUDIO FEEDBACK =====
    const AudioFeedback = (() => {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      
      function beep(freq, duration, volume = 0.15) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.value = volume;
        
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + duration / 1000);
      }

      return {
        success: () => { beep(800, 80); setTimeout(() => beep(1000, 80), 100); },
        error: () => { beep(400, 150); setTimeout(() => beep(350, 150), 180); },
        complete: () => {
          beep(600, 60);
          setTimeout(() => beep(800, 60), 80);
          setTimeout(() => beep(1000, 120), 160);
        }
      };
    })();

    function playAudioFeedback(type) {
      try {
        if (AudioFeedback[type]) AudioFeedback[type]();
      } catch (e) {
        log("Audio feedback error:", e);
      }
    }

    // ===== COOLDOWN =====
    function enterCooldown() {
      isInCooldown = true;
      const overlay = document.getElementById("scanOverlay");
      overlay.classList.remove("scanning");
      overlay.classList.add("cooldown");

      if (cooldownTimer) clearTimeout(cooldownTimer);
      cooldownTimer = setTimeout(exitCooldown, COOLDOWN_MS);
    }

    function exitCooldown() {
      isInCooldown = false;
      const overlay = document.getElementById("scanOverlay");
      overlay.classList.remove("cooldown");
      overlay.classList.add("scanning");
    }

    // ===== USER CONFIRMATION MODAL (Initial Scan) =====
    function showUserConfirmationModal(uid, name) {
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.innerHTML = `
        <div class="modal-content">
          <div class="checkmark-icon">‚úì</div>
          <h2>User Identified</h2>
          <div class="user-info">
            <strong>${uid}</strong>
            ${name ? name : ''}
          </div>
          <div class="next-step">
            <div class="arrow-icon">‚Üí</div>
            <p>Now scan iPads</p>
          </div>
          <button class="modal-close" onclick="this.parentElement.parentElement.remove()">GOT IT</button>
        </div>
      `;
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 2500);
    }

    // ===== PHASE III: VERIFICATION MODAL (Two-Stage Protocol) =====
    function showVerificationModal() {
      if (!userId || sessionHistory.length === 0) return;

      const overlay = document.createElement("div");
      overlay.className = "verification-modal-overlay";
      
      const actionText = mode === "borrow" ? "Check Out" : "Return";
      const actionTextLower = mode === "borrow" ? "borrow" : "return";
      
      let itemsHtml = sessionHistory.map(ipadId => `
        <div class="verification-item">
          <div class="verification-item-icon">üì±</div>
          <div class="verification-item-text">${ipadId}</div>
        </div>
      `).join('');

      overlay.innerHTML = `
        <div class="verification-modal-content">
          <h2>‚ö†Ô∏è Confirm ${actionText}</h2>
          <div class="subtitle">Review before submitting to database</div>
          
          <div class="verification-summary">
            <div class="verification-summary-item">
              <div class="verification-summary-label">User</div>
              <div class="verification-summary-value">${userId}</div>
            </div>
            <div class="verification-summary-item">
              <div class="verification-summary-label">Total iPads</div>
              <div class="verification-summary-value">${sessionHistory.length}</div>
            </div>
          </div>

          <div class="verification-items-container">
            ${itemsHtml}
          </div>

          <div class="verification-modal-buttons">
            <button class="verification-btn verification-btn-cancel" onclick="this.closest('.verification-modal-overlay').remove()">
              Cancel
            </button>
            <button class="verification-btn verification-btn-confirm" id="confirmSubmitBtn">
              ‚úì Confirm & Submit
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      // PHASE III: Attach haptic and submit to user gesture (button click)
      document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
        triggerHaptic('light');
        overlay.remove();
        finishSession();
      });
    }

    // ===== PHASE III: RESULTS MODAL (Granular Error Reporting) =====
    function showResultsModal(results) {
      const successCount = results.filter(r => r.status === 'success').length;
      const failureCount = results.filter(r => r.status === 'failed' || r.status === 'failure').length;
      const hasFailures = failureCount > 0;

      const overlay = document.createElement("div");
      overlay.className = "results-modal-overlay";
      
      let itemsHtml = results.map(item => {
        const isSuccess = item.status === 'success';
        const icon = isSuccess ? '‚úÖ' : '‚ùå';
        const itemClass = isSuccess ? '' : 'failure';
        const reason = item.reason || (isSuccess ? 'Completed successfully' : 'Operation failed');
        
        return `
          <div class="result-item ${itemClass}">
            <div class="result-item-icon">${icon}</div>
            <div class="result-item-content">
              <div class="result-item-id">${item.ipadId || item.id}</div>
              <div class="result-item-reason">${reason}</div>
            </div>
          </div>
        `;
      }).join('');

      const modalClass = hasFailures ? 'has-errors' : '';
      const summaryClass = hasFailures ? 'has-failures' : '';
      const summaryText = hasFailures 
        ? `Transaction completed with ${failureCount} error${failureCount > 1 ? 's' : ''}`
        : 'All operations completed successfully';

      overlay.innerHTML = `
        <div class="results-modal-content ${modalClass}">
          <h2>${hasFailures ? '‚ö†Ô∏è' : '‚úÖ'} Transaction Results</h2>
          
          <div class="results-summary ${summaryClass}">
            <div class="results-summary-text">${summaryText}</div>
            <div class="results-summary-stats">
              <div class="results-stat success">
                <div class="results-stat-icon">‚úÖ</div>
                <div>
                  <div class="results-stat-label">Success</div>
                  <div class="results-stat-value">${successCount}</div>
                </div>
              </div>
              ${failureCount > 0 ? `
                <div class="results-stat failure">
                  <div class="results-stat-icon">‚ùå</div>
                  <div>
                    <div class="results-stat-label">Failed</div>
                    <div class="results-stat-value">${failureCount}</div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="results-items-container">
            ${itemsHtml}
          </div>

          <button class="results-modal-close" onclick="this.closest('.results-modal-overlay').remove(); resetAll();">
            ${hasFailures ? 'Close & Review' : 'Done'}
          </button>
        </div>
      `;

      document.body.appendChild(overlay);

      // Trigger haptic based on results
      if (hasFailures) {
        triggerHaptic('error');
      } else {
        triggerHaptic('success');
      }
    }

    // ===== QR CODE SCAN HANDLER =====
    function onScanSuccess(decodedText) {
      const now = Date.now();
      const clean = (decodedText || "").toString().trim().toUpperCase();
      if (!clean) return;

      if (isInCooldown) {
        log("Scan blocked - in cooldown");
        return;
      }

      if (clean === lastScanned && (now - lastScanTime) < DUPLICATE_WINDOW) {
        updateBanner("DUPLICATE SCAN - MOVE TO NEXT", "status-warning");
        triggerFeedback('warning');
        return;
      }

      lastScanned = clean;
      lastScanTime = now;

      // STEP 1: User ID Scan
      if (!userId) {
        let isValidUser = false;
        
        if (knownUsersSet.size > 0) {
          if (knownUsersSet.has(clean)) {
            isValidUser = true;
          } else {
            updateBanner("USER NOT IN ROSTER", "status-error");
            triggerFeedback('error');
            log("User not in roster:", clean);
            return;
          }
        } else {
          isValidUser = true;
          log("Offline mode: Accepting user ID:", clean);
        }

        if (isValidUser) {
          userId = clean;
          
          showUserConfirmationModal(userId, "");
          
          document.getElementById("userPanel").style.display = "flex";
          document.getElementById("currentUserId").innerText = userId;
          document.getElementById("emptyTransactionState").style.display = "none";
          updateBanner("USER OK. NOW SCAN IPADS", "status-success");
          
          triggerFeedback('success');
          enterCooldown();
        }
        return;
      }

      // STEP 2: iPad/Asset ID Scan
      let isValidAsset = false;
      
      if (knownIpadsSet.size > 0) {
        if (knownIpadsSet.has(clean)) {
          isValidAsset = true;
        } else {
          updateBanner("UNKNOWN ASSET - NOT IN INVENTORY", "status-error");
          triggerFeedback('error');
          log("Asset not in inventory:", clean);
          return;
        }
      } else {
        isValidAsset = true;
        log("Offline mode: Accepting asset ID:", clean);
      }

      if (isValidAsset) {
        if (mode === "borrow" && unavailableIpads.includes(clean)) {
          updateBanner("UNAVAILABLE (BORROWED OR BLOCKED)", "status-error");
          triggerFeedback('error');
          return;
        }

        if (sessionHistory.includes(clean)) {
          updateBanner("ALREADY IN THIS SESSION", "status-warning");
          triggerFeedback('warning');
          return;
        }

        sessionHistory.push(clean);
        addHistoryRowBottom_(clean);

        updateBanner("‚úì " + clean + " - SCAN NEXT", "status-success");
        triggerFeedback('success');
        
        enterCooldown();
        return;
      }

      updateBanner("INVALID QR CODE", "status-error");
      triggerFeedback('error');
    }

    function updateCount_() {
      const count = sessionHistory.length;
      document.getElementById("sessionCount").innerText = count;
      document.getElementById("finishBtn").disabled = (count === 0 || !userId || isProcessing);
    }

    function ensureHistoryVisible_() {
      const list = document.getElementById("historyList");
      if (list.style.display !== "flex") list.style.display = "flex";
      document.getElementById("emptyTransactionState").style.display = "none";
    }

    function addHistoryRowBottom_(ipadId) {
      const list = document.getElementById("historyList");
      ensureHistoryVisible_();

      const row = document.createElement("div");
      row.className = "history-row";

      const label = document.createElement("span");
      label.className = "history-label";
      label.textContent = ipadId;

      const btn = document.createElement("button");
      btn.className = "delete-btn";
      btn.textContent = "DELETE";
      btn.onclick = () => removeById_(ipadId);

      row.appendChild(label);
      row.appendChild(btn);

      list.appendChild(row);
      historyDom.set(ipadId, row);
      updateCount_();
    }

    function removeById_(ipadId) {
      const idx = sessionHistory.indexOf(ipadId);
      if (idx >= 0) sessionHistory.splice(idx, 1);

      const el = historyDom.get(ipadId);
      if (el && el.parentNode) el.parentNode.removeChild(el);
      historyDom.delete(ipadId);

      updateCount_();
      if (sessionHistory.length === 0) {
        document.getElementById("historyList").style.display = "none";
        document.getElementById("emptyTransactionState").style.display = "block";
        updateBanner(userId ? "READY. SCAN NEXT IPAD" : "STEP 1: SCAN USER ID", "status-waiting");
      }
    }

    function clearHistoryDom_() {
      historyDom.clear();
      const list = document.getElementById("historyList");
      list.innerHTML = "";
    }

    async function clearAll() {
      if (sessionHistory.length === 0 && !userId) return;

      if (confirm("Clear and reset for next user?")) {
        resetAll();
        await stopZXingScanner();
        await initZXingScanner();
      }
    }

    function resetAll() {
      userId = null;
      sessionHistory = [];
      isProcessing = false;
      document.getElementById("finishBtn").disabled = false;
      document.getElementById("userPanel").style.display = "none";
      document.getElementById("historyList").style.display = "none";
      document.getElementById("emptyTransactionState").style.display = "block";
      clearHistoryDom_();
      updateCount_();
      updateBanner("STEP 1: SCAN USER ID", "status-waiting");
      
      if (cooldownTimer) clearTimeout(cooldownTimer);
      exitCooldown();
    }

    function setMode(m) {
      if (isProcessing) {
        updateBanner("SAVING IN PROGRESS", "status-warning");
        return;
      }
      
      mode = m;
      document.getElementById("btnBorrow").classList.toggle("active", m === "borrow");
      document.getElementById("btnReturn").classList.toggle("active", m === "return");
      
      resetAll();
      syncSystemCache();
    }

    // ===== PHASE III: Enhanced finishSession with detailed result handling =====
    async function finishSession() {
      if (!userId || sessionHistory.length === 0 || isProcessing) return;

      isProcessing = true;
      document.getElementById("finishBtn").disabled = true;
      updateBanner("SAVING...", "status-warning");

      const payload = {
        action: mode,
        userId: userId,
        ipadId: sessionHistory,
        requestId: makeRequestId()
      };

      const maxRetries = 3;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const controller = new AbortController();
          const t = setTimeout(() => controller.abort(), 15000);

          const resp = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          clearTimeout(t);

          let result = null;
          try { result = await resp.json(); } catch (e) {
            log("JSON parse error:", e);
          }

          // PHASE III: Handle granular results
          if (result && result.success && result.results && Array.isArray(result.results)) {
            updateBanner("TRANSACTION COMPLETE", "status-success");
            triggerFeedback('complete');

            await syncSystemCache();

            // Show detailed results modal
            showResultsModal(result.results);
            
            // Add to completed history
            addToCompletedHistory(userId, sessionHistory, mode);
            
            return;
          }

          // Handle partial failures with detailed results
          if (result && result.results && Array.isArray(result.results) && result.results.length > 0) {
            updateBanner("PARTIAL SUCCESS - CHECK DETAILS", "status-warning");
            
            await syncSystemCache();
            showResultsModal(result.results);
            
            return;
          }

          // Legacy error handling (backward compatible)
          if (result && (result.error || result.message)) {
            const msg = (result.message || result.error || "SAVE FAILED").toString().toUpperCase();
            updateBanner(msg, "status-error");
            triggerFeedback('error');
            isProcessing = false;
            document.getElementById("finishBtn").disabled = false;
            return;
          }

          throw new Error("Save failed - no valid response");

        } catch (err) {
          log("Save attempt failed:", attempt, err);

          if (err.name === 'AbortError') {
            updateBanner("REQUEST TIMEOUT - CHECK CONNECTION", "status-error");
            triggerFeedback('error');
            isProcessing = false;
            document.getElementById("finishBtn").disabled = false;
            return;
          }

          if (attempt < maxRetries) {
            updateBanner("RETRYING " + attempt + " OF " + maxRetries, "status-warning");
            await new Promise(r => setTimeout(r, 700 * attempt));
          } else {
            triggerFeedback('error');
            updateBanner("SAVE FAILED. TAP TO RETRY", "status-error");

            isProcessing = false;
            document.getElementById("finishBtn").disabled = false;
          }
        }
      }
    }

    // ===== COMPLETED HISTORY TRACKING =====
    function addToCompletedHistory(user, items, action) {
      const historyContainer = document.getElementById('completedHistory');
      
      // Clear empty state on first item
      if (historyContainer.querySelector('.empty-state')) {
        historyContainer.innerHTML = '';
        historyContainer.style.display = 'block';
        historyContainer.style.overflowY = 'auto';
        historyContainer.style.padding = '12px';
      }

      const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      const actionText = action === 'borrow' ? 'üì§ CHECKOUT' : 'üì• RETURN';
      const actionColor = action === 'borrow' ? '#3b82f6' : '#10b981';

      const entry = document.createElement('div');
      entry.style.cssText = `
        background: #1e293b;
        border-left: 3px solid ${actionColor};
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
        font-size: 13px;
      `;
      
      entry.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          <span style="font-weight: 700; color: ${actionColor};">${actionText}</span>
          <span style="color: #64748b; font-size: 11px;">${timestamp}</span>
        </div>
        <div style="color: #94a3b8; font-family: monospace; font-size: 12px;">
          ${user} ¬∑ ${items.length} item${items.length > 1 ? 's' : ''}
        </div>
      `;

      historyContainer.insertBefore(entry, historyContainer.firstChild);

      // Keep only last 10 entries
      while (historyContainer.children.length > 10) {
        historyContainer.removeChild(historyContainer.lastChild);
      }
    }

    // ===== UTILITY =====
    function makeRequestId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    // ===== INITIALIZATION =====
    window.addEventListener("DOMContentLoaded", async () => {
      log("App starting...");
      await syncSystemCache();
      await initZXingScanner();
      updateCount_();
      log("Ready");
    });
  </script>
</body>
</html>
