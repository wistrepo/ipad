<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>iPad Express Checkout v2.0</title>

  <!-- ZXing QR Code Library - Better iOS Compatibility -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    :root{
      --primary:#4f46e5;
      --success:#10b981;
      --bg:#0f172a;
      --panel:#1e293b;
      --danger:#ef4444;
      --gray:#334155;
      --warning:#f59e0b;
      --vh:1vh;
    }

    *{ box-sizing:border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:#fff;
      margin:0;
      display:flex;
      flex-direction:column;
      height:calc(var(--vh) * 100);
      overflow:hidden;
      -webkit-user-select:none;
      -webkit-tap-highlight-color:transparent;
      /* iOS safe area support */
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }

    .header{
      padding:10px;
      background:var(--panel);
      border-bottom:1px solid var(--gray);
      flex-shrink:0;
    }

    .mode-toggle{
      display:flex;
      background:#0f172a;
      border-radius:10px;
      padding:4px;
      margin:0 auto;
      width:min(520px, 100%);
    }

    .mode-btn{
      flex:1;
      padding:12px;
      border:none;
      border-radius:8px;
      color:#94a3b8;
      background:none;
      font-size:1.05rem;
      font-weight:800;
      cursor:pointer;
      transition:0.2s;
    }

    .mode-btn.active{
      background:var(--primary);
      color:#fff;
    }

    #reader-container{
      width:min(560px, 100%);
      margin:10px auto 0;
      padding:0 12px;
      position:relative;
      flex-shrink:0;
    }

    #reader{
      width:100% !important;
      height:clamp(220px, 38vh, 360px) !important;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      border:2px solid var(--gray);
      object-fit:cover;
      display:block;
      /* iOS-specific viewport fix */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    /* Dynamic Island safe area */
    @supports (-webkit-touch-callout: none) {
      #reader {
        height: calc(clamp(220px, 38vh, 360px) - env(safe-area-inset-bottom)) !important;
      }
    }

    .scan-overlay{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:min(260px, 72vw);
      height:min(260px, 72vw);
      max-width:260px;
      max-height:260px;
      border:3px solid var(--success);
      border-radius:14px;
      pointer-events:none;
      opacity:0.55;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .scan-overlay.scanning{
      animation:pulse 2s infinite;
    }

    .scan-overlay.cooldown{
      border-color:var(--warning);
      opacity:0.3;
      animation:none;
    }

    .scan-overlay.feedback-success {
      border-color: #10b981;
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.6);
      animation: successPulse 0.5s ease-out;
    }

    .scan-overlay.feedback-error {
      border-color: #ef4444;
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
      animation: errorShake 0.5s ease-out;
    }

    @keyframes pulse{
      0%,100%{ opacity:0.55; }
      50%{ opacity:0.25; }
    }

    @keyframes successPulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translate(-50%, -50%) translateX(0); }
      25% { transform: translate(-50%, -50%) translateX(-10px); }
      75% { transform: translate(-50%, -50%) translateX(10px); }
    }

    .scan-corner{
      position:absolute;
      width:30px;
      height:30px;
      border:3px solid var(--success);
      transition:border-color 0.2s;
    }
    
    .scan-overlay.cooldown .scan-corner,
    .scan-overlay.feedback-error .scan-corner{
      border-color:var(--warning);
    }

    .scan-overlay.feedback-success .scan-corner{
      border-color:#10b981;
    }
    
    .scan-corner.tl{ top:0; left:0; border-right:none; border-bottom:none; }
    .scan-corner.tr{ top:0; right:0; border-left:none; border-bottom:none; }
    .scan-corner.bl{ bottom:0; left:0; border-right:none; border-top:none; }
    .scan-corner.br{ bottom:0; right:0; border-left:none; border-top:none; }

    /* ===== USER CONFIRMATION MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 3px solid #10b981;
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      max-width: 90%;
      width: 420px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .checkmark-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      margin: 0 auto 20px;
      animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .modal-content h2 {
      margin: 0 0 16px;
      font-size: 28px;
      color: #fff;
    }

    .user-info {
      font-size: 18px;
      color: #cbd5e1;
      margin-bottom: 24px;
    }

    .user-info strong {
      display: block;
      font-size: 24px;
      color: #10b981;
      margin-bottom: 8px;
      font-family: monospace;
    }

    .next-step {
      background: rgba(79, 70, 229, 0.2);
      border: 2px dashed #4f46e5;
      border-radius: 16px;
      padding: 20px;
      margin: 24px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .arrow-icon {
      font-size: 32px;
      color: #4f46e5;
      animation: bounce 1s infinite;
    }

    .next-step p {
      margin: 0;
      font-size: 18px;
      color: #e2e8f0;
      font-weight: 600;
    }

    .modal-close {
      background: #10b981;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: #059669;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(8px); }
    }

    .fade-out {
      animation: fadeOut 0.3s ease-in forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; transform: scale(0.95); }
    }

    /* ===== SCREEN FLASH FEEDBACK ===== */
    .screen-flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 99999;
      animation: flashEffect 0.4s ease-out;
      mix-blend-mode: screen;
    }

    .screen-flash-success {
      background: radial-gradient(circle, rgba(16, 185, 129, 0.4) 0%, transparent 70%);
    }

    .screen-flash-error {
      background: radial-gradient(circle, rgba(239, 68, 68, 0.5) 0%, transparent 70%);
    }

    .screen-flash-warning {
      background: radial-gradient(circle, rgba(245, 158, 11, 0.4) 0%, transparent 70%);
    }

    .screen-flash-complete {
      background: radial-gradient(circle, rgba(79, 70, 229, 0.5) 0%, transparent 70%);
    }

    @keyframes flashEffect {
      0% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.1); }
    }

    /* Respect user's motion preferences */
    @media (prefers-reduced-motion: reduce) {
      .screen-flash, .checkmark-icon, .arrow-icon {
        animation: none !important;
      }
      .scan-overlay {
        animation: none !important;
      }
    }

    .start-overlay{
      position:absolute;
      inset:0 12px 0 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.65);
      backdrop-filter:blur(8px);
      z-index:100;
    }

    .start-btn{
      background:linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
      color:#fff;
      font-size:1.2rem;
      padding:20px 48px;
      border:none;
      border-radius:50px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 10px 30px rgba(79,70,229,0.4);
      transition:0.3s;
    }

    .start-btn:active{ transform:scale(0.95); }

    .status-banner{
      padding:14px;
      text-align:center;
      font-weight:900;
      font-size:0.95rem;
      letter-spacing:0.5px;
      transition:0.2s;
    }

    .status-waiting{ background:#334155; color:#e2e8f0; }
    .status-success{ background:var(--success); color:#fff; }
    .status-error{ background:var(--danger); color:#fff; }
    .status-warning{ background:var(--warning); color:#000; }

    .user-panel{
      display:none;
      align-items:center;
      justify-content:space-between;
      background:var(--panel);
      padding:10px 14px;
      margin:8px 12px 0;
      border-radius:10px;
      border:2px solid var(--success);
    }

    .user-label{ 
      font-size:0.85rem; 
      color:#94a3b8; 
      margin-bottom:4px;
    }

    #currentUserId{
      font-size:1.15rem;
      font-weight:900;
      color:#fff;
      font-family:monospace;
    }

    .clear-btn{
      background:var(--danger);
      color:#fff;
      border:none;
      padding:10px 18px;
      border-radius:8px;
      font-size:0.85rem;
      font-weight:700;
      cursor:pointer;
    }

    .history-section{
      flex:1;
      overflow-y:auto;
      padding:8px 12px 12px;
    }

    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
    }

    .history-title{
      font-size:0.9rem;
      font-weight:900;
      color:#94a3b8;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    #sessionCount{
      background:var(--primary);
      color:#fff;
      padding:6px 12px;
      border-radius:8px;
      font-size:0.85rem;
      font-weight:900;
    }

    #historyList{
      display:none;
    }

    .history-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:var(--panel);
      padding:12px;
      margin:6px 0;
      border-radius:10px;
      border:1px solid var(--gray);
    }

    .history-label{
      font-family:monospace;
      font-weight:700;
      color:#e2e8f0;
      font-size:1rem;
    }

    .delete-btn{
      background:var(--danger);
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:6px;
      font-size:0.75rem;
      font-weight:700;
      cursor:pointer;
    }

    .footer{
      flex-shrink:0;
      padding:12px;
      background:var(--panel);
      border-top:1px solid var(--gray);
    }

    .finish-btn{
      width:100%;
      background:linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color:#fff;
      padding:18px;
      border:none;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 25px rgba(16,185,129,0.3);
      transition:0.3s;
    }

    .finish-btn:disabled{
      background:#475569;
      cursor:not-allowed;
      box-shadow:none;
    }

    .finish-btn:active:not(:disabled){ transform:scale(0.97); }
  </style>
</head>
<body>
  <div class="header">
    <div class="mode-toggle">
      <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
      <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
  </div>

  <div id="reader-container">
    <video id="reader" autoplay playsinline></video>
    <div class="scan-overlay scanning">
      <div class="scan-corner tl"></div>
      <div class="scan-corner tr"></div>
      <div class="scan-corner bl"></div>
      <div class="scan-corner br"></div>
    </div>
    <div id="startOverlay" class="start-overlay">
      <button class="start-btn" onclick="userStart()">SCAN QR CODE</button>
    </div>
  </div>

  <div class="status-banner status-waiting" id="statusBanner">READY TO START</div>

  <div class="user-panel" id="userPanel">
    <div>
      <div class="user-label">Current User:</div>
      <div id="currentUserId">â€”</div>
    </div>
    <button class="clear-btn" onclick="clearAll()">CLEAR</button>
  </div>

  <div class="history-section">
    <div class="history-header">
      <div class="history-title">Session Items</div>
      <div id="sessionCount">Qty: 0</div>
    </div>
    <div id="historyList"></div>
  </div>

  <div class="footer">
    <button id="finishBtn" class="finish-btn" onclick="finishSession()">FINISH & SAVE</button>
  </div>

  <script>
    // ===== CONFIG =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz38EuFK97iTsGqQf-b3BI108nJbzN6xZtEc2tqyk5K93I1kX9UIKqFVRD3DuCFUn_I/exec"; // UPDATE THIS
    const DEBUG_MODE = true;
    const DUPLICATE_WINDOW = 2000;
    const COOLDOWN_DURATION = 1500;

    // ===== STATE =====
    let mode = "borrow";
    let userId = null;
    let sessionHistory = [];
    let historyDom = new Map();
    let unavailableIpads = [];
    let knownUsersSet = new Set();
    let knownIpadsSet = new Set();
    let lastScanned = null;
    let lastScanTime = 0;
    let isProcessing = false;
    let isInCooldown = false;
    let cooldownTimer = null;
    let codeReader = null;

    // ===== MULTI-SENSORY FEEDBACK SYSTEM =====
    
    /**
     * Haptic feedback with pattern-based vibration
     */
    function triggerHaptic(type) {
      if (!navigator.vibrate) {
        console.warn('Vibration API not supported');
        return;
      }
      
      const patterns = {
        success: [25],
        error: [50, 100, 50],
        warning: [30, 50, 30],
        complete: [50, 100, 50, 100, 100]
      };
      
      try {
        navigator.vibrate(patterns[type] || [25]);
        console.log(`âœ“ Haptic: ${type}`);
      } catch (err) {
        console.error('Vibration error:', err);
      }
    }

    /**
     * Visual screen flash feedback
     */
    function triggerScreenFlash(type) {
      const overlay = document.createElement('div');
      overlay.className = `screen-flash screen-flash-${type}`;
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 400);
    }

    /**
     * Scan overlay visual feedback
     */
    function triggerOverlayFeedback(type) {
      const overlay = document.querySelector('.scan-overlay');
      overlay.classList.add(`feedback-${type}`);
      setTimeout(() => {
        overlay.classList.remove(`feedback-${type}`);
      }, 500);
    }

    /**
     * Universal multi-channel feedback
     */
    function triggerFeedback(type) {
      triggerHaptic(type);
      triggerScreenFlash(type);
      triggerOverlayFeedback(type);
      console.log(`ðŸŽ¯ Multi-sensory feedback: ${type}`);
    }

    // ===== USER CONFIRMATION MODAL =====
    
    function showUserConfirmationModal(userId, userName) {
      const existingModal = document.getElementById('userConfirmModal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.id = 'userConfirmModal';
      modal.innerHTML = `
        <div class="modal-overlay">
          <div class="modal-content">
            <div class="checkmark-icon">âœ“</div>
            <h2>User Verified</h2>
            <div class="user-info">
              <strong>${userId}</strong>
              ${userName ? userName : ''}
            </div>
            <div class="next-step">
              <div class="arrow-icon">â†’</div>
              <p>Now scan iPad asset tags</p>
            </div>
            <button class="modal-close" onclick="dismissModal()">Continue</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Auto-dismiss after 2.5 seconds
      setTimeout(() => dismissModal(), 2500);
    }

    function dismissModal() {
      const modal = document.getElementById('userConfirmModal');
      if (modal) {
        modal.classList.add('fade-out');
        setTimeout(() => modal.remove(), 300);
      }
    }

    // ===== ZXING QR SCANNER =====
    
    function log(...args) {
      if (DEBUG_MODE) console.log(...args);
    }

    function setVhUnit() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", `${vh}px`);
    }
    
    window.addEventListener("resize", setVhUnit);
    window.addEventListener("orientationchange", () => setTimeout(setVhUnit, 250));
    setVhUnit();

    function updateBanner(text, cls) {
      const b = document.getElementById("statusBanner");
      b.innerText = text;
      b.className = "status-banner " + cls;
      b.onclick = null;
      log("Banner:", text);
    }

    function enterCooldown() {
      isInCooldown = true;
      const overlay = document.querySelector('.scan-overlay');
      overlay.classList.remove('scanning');
      overlay.classList.add('cooldown');
      
      log('Cooldown started');
      
      cooldownTimer = setTimeout(() => {
        exitCooldown();
      }, COOLDOWN_DURATION);
    }

    function exitCooldown() {
      isInCooldown = false;
      const overlay = document.querySelector('.scan-overlay');
      overlay.classList.remove('cooldown');
      overlay.classList.add('scanning');
      
      log('Cooldown ended');
    }

    async function initZXingScanner() {
      try {
        if (codeReader) {
          codeReader.reset();
        }

        codeReader = new ZXing.BrowserQRCodeReader();
        
        const videoInputDevices = await codeReader.listVideoInputDevices();
        log('Available cameras:', videoInputDevices.length);
        
        if (videoInputDevices.length === 0) {
          throw new Error('No camera found');
        }
        
        // Prefer back camera
        const selectedDeviceId = videoInputDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('environment')
        )?.deviceId || videoInputDevices[0]?.deviceId;
        
        const constraints = {
          video: {
            deviceId: { exact: selectedDeviceId },
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            aspectRatio: { ideal: 16/9 }
          }
        };
        
        await codeReader.decodeFromConstraints(
          constraints,
          'reader',
          (result, error) => {
            if (result) {
              onScanSuccess(result.text);
            }
          }
        );
        
        log('ZXing scanner started successfully');
        updateBanner("SYNCING STATUS...", "status-waiting");
        await syncSystemCache();
        
      } catch (err) {
        console.error('ZXing initialization failed:', err);
        updateBanner("CAMERA ERROR. TAP TO RETRY", "status-error");
        document.getElementById("startOverlay").style.display = "flex";
      }
    }

    async function stopZXingScanner() {
      if (codeReader) {
        codeReader.reset();
        log('ZXing scanner stopped');
      }
    }

    async function userStart() {
      triggerHaptic('success');
      document.getElementById("startOverlay").style.display = "none";
      updateBanner("STARTING CAMERA...", "status-waiting");
      await initZXingScanner();
    }

    async function syncSystemCache(retryCount = 0) {
      const maxRetries = 3;
      try {
        const resp = await fetch(SCRIPT_URL, { method: "GET", cache: "no-cache" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || "Bad response");

        unavailableIpads = (data.borrowed || [])
          .map(x => (x || "").toString().trim().toUpperCase())
          .filter(Boolean);

        knownUsersSet = new Set(
          (data.userIds || [])
            .map(x => (x || "").toString().trim().toUpperCase())
            .filter(Boolean)
        );

        knownIpadsSet = new Set(
          (data.inventoryIds || [])
            .map(x => (x || "").toString().trim().toUpperCase())
            .filter(Boolean)
        );

        log("Cache synced:", {
          unavailable: unavailableIpads.length,
          users: knownUsersSet.size,
          inventory: knownIpadsSet.size
        });

        updateBanner(userId ? "READY. SCAN NEXT IPAD" : "STEP 1: SCAN USER ID", "status-waiting");

      } catch (err) {
        log("Sync failed:", err);
        if (retryCount < maxRetries) {
          setTimeout(() => syncSystemCache(retryCount + 1), 1000 * (retryCount + 1));
        } else {
          updateBanner("OFFLINE MODE", "status-warning");
        }
      }
    }

    function makeRequestId() {
      try {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
      } catch (e) {}
      return "RID_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    function onScanSuccess(decodedText) {
      const now = Date.now();
      const clean = (decodedText || "").toString().trim().toUpperCase();
      if (!clean) return;

      if (isInCooldown) {
        log("Scan blocked - in cooldown");
        return;
      }

      if (clean === lastScanned && (now - lastScanTime) < DUPLICATE_WINDOW) {
        updateBanner("DUPLICATE SCAN - MOVE TO NEXT", "status-warning");
        triggerFeedback('warning');
        return;
      }

      lastScanned = clean;
      lastScanTime = now;

      // STEP 1: User ID Scan
      if (!userId) {
        let isValidUser = false;
        
        if (knownUsersSet.size > 0) {
          if (knownUsersSet.has(clean)) {
            isValidUser = true;
          } else {
            updateBanner("USER NOT IN ROSTER", "status-error");
            triggerFeedback('error');
            log("User not in roster:", clean);
            return;
          }
        } else {
          isValidUser = true;
          log("Offline mode: Accepting user ID:", clean);
        }

        if (isValidUser) {
          userId = clean;
          
          // Show confirmation modal
          showUserConfirmationModal(userId, "");
          
          document.getElementById("userPanel").style.display = "flex";
          document.getElementById("currentUserId").innerText = userId;
          updateBanner("USER OK. NOW SCAN IPADS", "status-success");
          
          triggerFeedback('success');
          enterCooldown();
        }
        return;
      }

      // STEP 2: iPad/Asset ID Scan
      let isValidAsset = false;
      
      if (knownIpadsSet.size > 0) {
        if (knownIpadsSet.has(clean)) {
          isValidAsset = true;
        } else {
          updateBanner("UNKNOWN ASSET - NOT IN INVENTORY", "status-error");
          triggerFeedback('error');
          log("Asset not in inventory:", clean);
          return;
        }
      } else {
        isValidAsset = true;
        log("Offline mode: Accepting asset ID:", clean);
      }

      if (isValidAsset) {
        if (mode === "borrow" && unavailableIpads.includes(clean)) {
          updateBanner("UNAVAILABLE (BORROWED OR BLOCKED)", "status-error");
          triggerFeedback('error');
          return;
        }

        if (sessionHistory.includes(clean)) {
          updateBanner("ALREADY IN THIS SESSION", "status-warning");
          triggerFeedback('warning');
          return;
        }

        sessionHistory.push(clean);
        addHistoryRowBottom_(clean);

        updateBanner("âœ“ " + clean + " - SCAN NEXT", "status-success");
        triggerFeedback('success');
        
        enterCooldown();
        return;
      }

      updateBanner("INVALID QR CODE", "status-error");
      triggerFeedback('error');
    }

    function updateCount_() {
      document.getElementById("sessionCount").innerText = "Qty: " + sessionHistory.length;
    }

    function ensureHistoryVisible_() {
      const list = document.getElementById("historyList");
      if (list.style.display !== "block") list.style.display = "block";
    }

    function addHistoryRowBottom_(ipadId) {
      const list = document.getElementById("historyList");
      ensureHistoryVisible_();

      const row = document.createElement("div");
      row.className = "history-row";

      const label = document.createElement("span");
      label.className = "history-label";
      label.textContent = ipadId;

      const btn = document.createElement("button");
      btn.className = "delete-btn";
      btn.textContent = "DELETE";
      btn.onclick = () => removeById_(ipadId);

      row.appendChild(label);
      row.appendChild(btn);

      list.appendChild(row);
      historyDom.set(ipadId, row);
      updateCount_();
    }

    function removeById_(ipadId) {
      const idx = sessionHistory.indexOf(ipadId);
      if (idx >= 0) sessionHistory.splice(idx, 1);

      const el = historyDom.get(ipadId);
      if (el && el.parentNode) el.parentNode.removeChild(el);
      historyDom.delete(ipadId);

      updateCount_();
      if (sessionHistory.length === 0) {
        document.getElementById("historyList").style.display = "none";
        updateBanner(userId ? "READY. SCAN NEXT IPAD" : "STEP 1: SCAN USER ID", "status-waiting");
      }
    }

    function clearHistoryDom_() {
      historyDom.clear();
      const list = document.getElementById("historyList");
      list.innerHTML = "";
    }

    async function clearAll() {
      if (sessionHistory.length === 0 && !userId) return;

      if (confirm("Clear and reset for next user?")) {
        resetAll();
        await stopZXingScanner();
        await initZXingScanner();
      }
    }

    function resetAll() {
      userId = null;
      sessionHistory = [];
      isProcessing = false;
      document.getElementById("finishBtn").disabled = false;
      document.getElementById("userPanel").style.display = "none";
      document.getElementById("historyList").style.display = "none";
      clearHistoryDom_();
      updateCount_();
      updateBanner("STEP 1: SCAN USER ID", "status-waiting");
      
      if (cooldownTimer) clearTimeout(cooldownTimer);
      exitCooldown();
    }

    function setMode(m) {
      if (isProcessing) {
        updateBanner("SAVING IN PROGRESS", "status-warning");
        return;
      }
      
      mode = m;
      document.getElementById("btnBorrow").classList.toggle("active", m === "borrow");
      document.getElementById("btnReturn").classList.toggle("active", m === "return");
      
      resetAll();
      syncSystemCache();
    }

    async function finishSession() {
      if (!userId || sessionHistory.length === 0 || isProcessing) return;

      isProcessing = true;
      document.getElementById("finishBtn").disabled = true;
      updateBanner("SAVING...", "status-warning");

      const payload = {
        action: mode,
        userId: userId,
        ipadId: sessionHistory,
        requestId: makeRequestId()
      };

      const maxRetries = 3;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const controller = new AbortController();
          const t = setTimeout(() => controller.abort(), 15000);

          const resp = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          clearTimeout(t);

          let result = null;
          try { result = await resp.json(); } catch (e) {}

          if (result && result.success) {
            updateBanner("SAVED. NEXT USER", "status-success");
            triggerFeedback('complete');

            await syncSystemCache();

            setTimeout(resetAll, 700);
            return;
          }

          if (result && (result.error || result.message)) {
            const msg = (result.message || result.error || "SAVE FAILED").toString().toUpperCase();
            updateBanner(msg, "status-error");
            triggerFeedback('error');
            isProcessing = false;
            document.getElementById("finishBtn").disabled = false;
            return;
          }

          throw new Error("Save failed");

        } catch (err) {
          log("Save attempt failed:", attempt, err);

          if (attempt < maxRetries) {
            updateBanner("RETRYING " + attempt + " OF " + maxRetries, "status-warning");
            await new Promise(r => setTimeout(r, 700 * attempt));
          } else {
            triggerFeedback('error');
            updateBanner("SAVE FAILED. TAP TO RETRY", "status-error");

            isProcessing = false;
            document.getElementById("finishBtn").disabled = false;

            document.getElementById("statusBanner").onclick = () => {
              document.getElementById("statusBanner").onclick = null;
              finishSession();
            };
          }
        }
      }
    }
  </script>
</body>
</html>
